<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>iPod Classic PRO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
      margin: 0; height: 100%; overflow: hidden; touch-action: none;
    }
    body {
      background: #cfd4d8;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      display: flex; justify-content: center; align-items: center;
    }
    .ipod-shell {
      width: 300px; height: 540px;
      background: linear-gradient(to bottom, #ddd, #aaa);
      border-radius: 40px; box-shadow: inset 0 0 10px rgba(0,0,0,0.4), 0 10px 30px rgba(0,0,0,0.4);
      display: flex; flex-direction: column; align-items: center; padding: 20px; position: relative;
    }
    .ipod-screen {
      width: 240px; height: 220px;
      background: radial-gradient(circle at 30% 30%, #e0f1f5 0%, #b3cbd4 100%);
      border: 4px solid #333; border-radius: 14px; box-shadow: inset 0 0 15px rgba(0,0,0,0.3);
      position: relative; padding: 10px; overflow: hidden; font-size: 12px;
    }
    .ipod-screen::before {
      content: ''; position: absolute; inset: 0;
      background: repeating-linear-gradient(0deg, transparent 0 2px, rgba(0,0,0,0.03) 2px 3px);
      pointer-events: none; border-radius: 14px;
    }
    .status-bar {
      display: flex; justify-content: space-between; font-size: 10px; color: #333; margin-bottom: 6px;
    }
    .screen-item { padding: 4px; border-radius: 4px; }
    .screen-item.selected { background: #007aff; color: #fff; }
    .progress-bar { width: 100%; height: 4px; background: #ccc; margin-top: 8px; border-radius: 2px; }
    .progress { height: 100%; background: #007aff; border-radius: 2px; width: 0%; }
    iframe { width: 100%; height: 150px; }
    .clickwheel {
      width: 180px; height: 180px; background: radial-gradient(circle at center, #ddd 0%, #999 90%);
      border-radius: 50%; margin-top: auto; position: relative;
      box-shadow: inset 0 0 25px rgba(0,0,0,0.4); touch-action: none;
    }
    .clickwheel::before {
      content: ''; position: absolute; inset: 0; border-radius: 50%;
      background: radial-gradient(circle at center, rgba(255,255,255,0.2) 0%, transparent 70%);
    }
    .clickwheel .btn {
      position: absolute; font-size: 10px; font-weight: bold; color: #333;
    }
    .btn.menu { top: 12px; left: 50%; transform: translateX(-50%); }
    .btn.back { left: 10px; top: 50%; transform: translateY(-50%); }
    .btn.forward { right: 10px; top: 50%; transform: translateY(-50%); }
    .btn.play { bottom: 12px; left: 50%; transform: translateX(-50%); }
    .center-button {
      width: 60px; height: 60px; border-radius: 50%; background: #555;
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      cursor: pointer; box-shadow: inset 0 0 8px rgba(0,0,0,0.3);
    }
    input, button { margin: 2px 0; font-size: 12px; width: 100%; }
    .volume-btn {
      position: absolute; width: 20px; height: 40px;
      background: #666; border-radius: 10px; opacity: 0.5; cursor: pointer;
    }
    .volume-up { right: -25px; top: 150px; }
    .volume-down { right: -25px; top: 200px; }
    .now-playing-bar {
      position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%);
      text-align: center; font-size: 10px;
    }
    .equalizer {
      display: inline-block; width: 30px; height: 10px; margin-top: 2px;
    }
    .equalizer div {
      display: inline-block; width: 3px; background: #007aff; margin: 0 1px; animation: bounce 1s infinite ease-in-out alternate;
    }
    .equalizer div:nth-child(2) { animation-delay: 0.2s; }
    .equalizer div:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce {
      from { height: 4px; } to { height: 10px; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    function App() {
      const [pin, setPin] = useState('');
      const [username, setUsername] = useState('');
      const [loggedIn, setLoggedIn] = useState(false);
      const [battery, setBattery] = useState('--%');
      const [audioOut, setAudioOut] = useState('Altavoz');
      const [screen, setScreen] = useState('menu');
      const [selected, setSelected] = useState(0);
      const [songs, setSongs] = useState([]);
      const [current, setCurrent] = useState(null);
      const [playing, setPlaying] = useState(false);
      const [volume, setVolume] = useState(0.5);
      const audioRef = useRef(null);
      const [progress, setProgress] = useState(0);
      const titleRef = useRef();
      const urlRef = useRef();

      const userKey = `${username}_${pin}`;

      useEffect(() => {
        if (loggedIn && 'getBattery' in navigator) {
          navigator.getBattery().then(bat => {
            setBattery(Math.round(bat.level * 100) + '%');
            bat.addEventListener('levelchange', () => {
              setBattery(Math.round(bat.level * 100) + '%');
            });
          });
        }
        if (loggedIn && navigator.mediaDevices?.enumerateDevices) {
          navigator.mediaDevices.enumerateDevices().then(devices => {
            const audioOuts = devices.filter(d => d.kind === 'audiooutput');
            setAudioOut(audioOuts.length > 0 ? 'Audífonos' : 'Altavoz');
          });
        }
      }, [loggedIn]);

      useEffect(() => {
        if (loggedIn) {
          const s = localStorage.getItem(`${userKey}_songs`);
          setSongs(s ? JSON.parse(s) : []);
        }
      }, [loggedIn]);

      useEffect(() => {
        if (audioRef.current) {
          audioRef.current.volume = volume;
          audioRef.current.ontimeupdate = () => {
            setProgress(audioRef.current.duration ? audioRef.current.currentTime / audioRef.current.duration : 0);
          };
        }
      }, [current, volume]);

      const saveData = () => localStorage.setItem(`${userKey}_songs`, JSON.stringify(songs));

      const handleLogin = () => {
        if (username.trim() === '' || !/^\d{4}$/.test(pin)) {
          alert('Usuario y PIN numérico de 4 dígitos requeridos'); return;
        }
        setLoggedIn(true); setScreen('menu'); setSelected(0);
      };

      const renderScreen = () => {
        if (screen === 'menu') {
          return ['Biblioteca', 'Añadir Música', 'Borrar Todo'].map((item, i) =>
            <div key={i} className={`screen-item ${i === selected ? 'selected' : ''}`}>{item}</div>);
        }
        if (screen === 'library') {
          return songs.length === 0 ? <div>No hay música.</div> :
            songs.map((s, i) =>
              <div key={i} className={`screen-item ${i === selected ? 'selected' : ''}`}>{s.title}</div>);
        }
        if (screen === 'add') {
          return <>
            URL MP3:<br /><input ref={urlRef} /><br />
            <button onClick={addSong}>Guardar</button>
          </>;
        }
      };

      const addSong = () => {
        const url = urlRef.current.value.trim();
        if (url) {
          let name = url.split('/').pop().split('.')[0] || 'Track';
          const newS = [...songs, { title: name, url }];
          setSongs(newS); saveData(); alert('Añadido'); setScreen('menu');
        }
      };

      const selectItem = () => {
        if (screen === 'menu') {
          if (selected === 0) setScreen('library');
          else if (selected === 1) setScreen('add');
          else if (selected === 2) { if (confirm('¿Seguro?')) { setSongs([]); saveData(); } }
          setSelected(0);
        } else if (screen === 'library') {
          const s = songs[selected];
          if (s) {
            setCurrent(s); const audio = audioRef.current;
            audio.src = s.url; audio.load();
            audio.play().then(() => setPlaying(true));
            setScreen('menu');
          }
        }
      };

      const prevItem = () => setSelected(Math.max(0, selected - 1));
      const nextItem = () => {
        let max = screen === 'menu' ? 2 : songs.length - 1;
        setSelected(Math.min(max, selected + 1));
      };

      const togglePlay = () => {
        if (current) { playing ? audioRef.current.pause() : audioRef.current.play(); setPlaying(!playing); }
      };
      const volUp = () => setVolume(v => Math.min(1, v + 0.1));
      const volDown = () => setVolume(v => Math.max(0, v - 0.1));

      const wheelRef = useRef(null); let lastA = null;
      const startRotate = (e) => { e.preventDefault(); lastA = null;
        window.addEventListener('mousemove', rot);
        window.addEventListener('touchmove', t => { t.preventDefault(); rot({ clientX: t.touches[0].clientX, clientY: t.touches[0].clientY }); }, { passive: false });
        window.addEventListener('mouseup', stop); window.addEventListener('touchend', stop); };
      const stop = () => { window.removeEventListener('mousemove', rot); window.removeEventListener('touchmove', rot); };
      const rot = (e) => { const r = wheelRef.current.getBoundingClientRect(), cx = r.left + r.width / 2, cy = r.top + r.height / 2,
        dx = e.clientX - cx, dy = e.clientY - cy, a = Math.atan2(dy, dx) * (180 / Math.PI);
        if (lastA !== null) { let d = a - lastA; if (d > 180) d -= 360; if (d < -180) d += 360; if (Math.abs(d) > 10) d > 0 ? nextItem() : prevItem(); } lastA = a; };

      if (!loggedIn) return <div>Usuario:<br/><input value={username} onChange={e => setUsername(e.target.value)}/><br/>
        PIN:<br/><input maxLength="4" pattern="\d*" inputMode="numeric" value={pin} onChange={e => setPin(e.target.value.replace(/\D/g,''))}/>
        <br/><button onClick={handleLogin}>Entrar</button></div>;

      return <div className="ipod-shell">
        <div className="ipod-screen">
          <div className="status-bar">Batería: {battery} | {audioOut}</div>
          {renderScreen()}
          <div className="progress-bar"><div className="progress" style={{ width: `${progress * 100}%` }}></div></div>
        </div>
        <div className="clickwheel" ref={wheelRef} onMouseDown={startRotate} onTouchStart={startRotate}>
          <div className="btn menu" onClick={() => { setScreen('menu'); setSelected(0); }}>MENU</div>
          <div className="btn back" onClick={() => audioRef.current.currentTime = 0}>{'<<'}</div>
          <div className="btn forward" onClick={() => audioRef.current.currentTime = audioRef.current.duration}>{'>>'}</div>
          <div className="btn play" onClick={togglePlay}>Play</div>
          <div className="center-button" onClick={selectItem}></div>
        </div>
        <div className="volume-btn volume-up" onClick={volUp}></div>
        <div className="volume-btn volume-down" onClick={volDown}></div>
        {current && playing && (
          <div className="now-playing-bar">
            {current.title}<br/>
            <div className="equalizer">
              <div></div><div></div><div></div>
            </div>
          </div>
        )}
        <audio ref={audioRef}></audio>
      </div>;
    }
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
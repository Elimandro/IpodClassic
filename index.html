<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>iPod Classic Modern Clone</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- React + Babel CDN -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body {
      margin: 0;
      background: linear-gradient(to bottom, #dfe3e6, #b3b7bb);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .ipod-shell {
      width: 300px;
      height: 520px;
      background: #f8f8f8;
      border-radius: 40px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.4), inset 0 0 8px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      position: relative;
    }
    .ipod-screen {
      width: 240px;
      height: 180px;
      background: #e0e0e0;
      border: 2px solid #333;
      border-radius: 14px;
      box-shadow: inset 0 0 12px rgba(0,0,0,0.2);
      overflow: hidden;
      position: relative;
      padding: 10px;
    }
    .battery {
      position: absolute;
      top: 6px;
      right: 12px;
      font-size: 10px;
      color: #333;
    }
    .screen-content {
      margin-top: 18px;
      font-size: 14px;
    }
    .screen-item {
      padding: 4px;
      border-radius: 4px;
    }
    .selected {
      background: #007aff;
      color: #fff;
    }
    .now-playing {
      text-align: center;
    }
    .progress-bar {
      width: 100%;
      height: 4px;
      background: #ccc;
      margin-top: 8px;
      border-radius: 2px;
    }
    .progress {
      height: 100%;
      background: #007aff;
      width: 0%;
      border-radius: 2px;
    }
    .clickwheel {
      width: 200px;
      height: 200px;
      background: radial-gradient(circle at center, #ddd 0%, #999 90%);
      border-radius: 50%;
      margin-top: auto;
      position: relative;
      box-shadow: inset 0 0 20px rgba(0,0,0,0.3);
    }
    .clickwheel .btn {
      position: absolute;
      font-size: 10px;
      font-weight: bold;
      color: #333;
    }
    .btn.menu { top: 12px; left: 50%; transform: translateX(-50%); }
    .btn.back { left: 10px; top: 50%; transform: translateY(-50%); }
    .btn.forward { right: 10px; top: 50%; transform: translateY(-50%); }
    .btn.play { bottom: 12px; left: 50%; transform: translateX(-50%); }
    .center-button {
      width: 60px; height: 60px;
      border-radius: 50%; background: #555;
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      cursor: pointer;
    }
    input, button {
      margin: 4px 0;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    function App() {
      const [pin, setPin] = useState('');
      const [loggedIn, setLoggedIn] = useState(false);
      const [battery, setBattery] = useState('--%');
      const [screen, setScreen] = useState('menu');
      const [selected, setSelected] = useState(0);
      const [songs, setSongs] = useState([]);
      const [current, setCurrent] = useState(null);
      const [playing, setPlaying] = useState(false);
      const audioRef = useRef(null);
      const ytTitleRef = useRef(null);
      const ytUrlRef = useRef(null);
      const [progress, setProgress] = useState(0);

      useEffect(() => {
        if (loggedIn && 'getBattery' in navigator) {
          navigator.getBattery().then(bat => {
            setBattery(`${Math.round(bat.level*100)}%`);
            bat.addEventListener('levelchange', () => {
              setBattery(`${Math.round(bat.level*100)}%`);
            });
          });
        }
      }, [loggedIn]);

      useEffect(() => {
        if (pin) {
          const data = localStorage.getItem(pin);
          setSongs(data ? JSON.parse(data) : []);
        }
      }, [pin]);

      useEffect(() => {
        if (audioRef.current) {
          audioRef.current.ontimeupdate = () => {
            setProgress(audioRef.current.duration ? audioRef.current.currentTime / audioRef.current.duration : 0);
          };
          audioRef.current.onended = nextSong;
        }
      }, [current]);

      function saveSongs(newSongs) {
        localStorage.setItem(pin, JSON.stringify(newSongs));
        setSongs(newSongs);
      }

      function handleLogin() {
        if (pin.length === 4) {
          setLoggedIn(true);
          setScreen('menu');
          setSelected(0);
        } else {
          alert('PIN debe tener 4 dígitos');
        }
      }

      function renderScreen() {
        if (screen === 'menu') {
          const items = ['▶ Biblioteca','+ Añadir música'];
          return items.map((item, i) =>
            <div key={i} className={`screen-item ${i===selected?'selected':''}`}>{item}</div>);
        }
        if (screen === 'library') {
          if (songs.length === 0) return <div>No hay canciones.</div>;
          return songs.map((song,i) =>
            <div key={i} className={`screen-item ${i===selected?'selected':''}`}>{song.title}</div>);
        }
        if (screen === 'add') {
          return (
            <>
              Título:<br/>
              <input ref={ytTitleRef}/><br/>
              URL MP3:<br/>
              <input ref={ytUrlRef}/><br/>
              <button onClick={addSong}>Guardar</button>
            </>
          );
        }
        if (screen === 'nowplaying') {
          if (!current) return <div>No hay canción seleccionada.</div>;
          return (
            <div className="now-playing">
              <div><strong>{current.title}</strong></div>
              <div style={{fontSize: '10px', margin: '4px 0'}}>{playing ? '▶ Reproduciendo' : '❙❙ Pausado'}</div>
              <div className="progress-bar"><div className="progress" style={{width: `${progress*100}%`}}></div></div>
            </div>
          );
        }
      }

      function addSong() {
        const title = ytTitleRef.current.value.trim();
        const url = ytUrlRef.current.value.trim();
        if (title && url) {
          const newList = [...songs, {title,url}];
          saveSongs(newList);
          alert('Añadido!');
          setScreen('menu');
          setSelected(0);
        } else {
          alert('Completa ambos campos');
        }
      }

      function selectItem() {
        if (screen === 'menu') {
          if (selected === 0) setScreen('library');
          else if (selected === 1) setScreen('add');
          setSelected(0);
        } else if (screen === 'library') {
          const song = songs[selected];
          if (song) {
            setCurrent(song);
            audioRef.current.src = song.url;
            audioRef.current.play();
            setPlaying(true);
            setScreen('nowplaying');
          }
        }
      }

      function prevItem() { setSelected(s => Math.max(0,s-1)); }
      function nextItem() {
        const max = screen==='menu'?1: songs.length-1;
        setSelected(s => Math.min(max,s+1));
      }

      function togglePlay() {
        if (!current) return;
        if (playing) { audioRef.current.pause(); setPlaying(false); }
        else { audioRef.current.play(); setPlaying(true); }
      }

      function nextSong() {
        if (!current) return;
        const idx = songs.findIndex(s=>s.title===current.title);
        if (idx < songs.length-1) {
          setCurrent(songs[idx+1]);
          audioRef.current.src = songs[idx+1].url;
          audioRef.current.play();
        }
      }

      function prevSong() {
        if (!current) return;
        const idx = songs.findIndex(s=>s.title===current.title);
        if (idx > 0) {
          setCurrent(songs[idx-1]);
          audioRef.current.src = songs[idx-1].url;
          audioRef.current.play();
        }
      }

      // ClickWheel
      const wheelRef = useRef(null);
      let lastAngle = null;
      function startRotate(e) {
        e.preventDefault();
        lastAngle = null;
        window.addEventListener('mousemove', rotate);
        window.addEventListener('touchmove', rotateTouch);
        window.addEventListener('mouseup', stopRotate);
        window.addEventListener('touchend', stopRotate);
      }
      function stopRotate() {
        window.removeEventListener('mousemove', rotate);
        window.removeEventListener('touchmove', rotateTouch);
      }
      function rotateTouch(e) {
        const t = e.touches[0];
        rotate({clientX:t.clientX, clientY:t.clientY});
      }
      function rotate(e) {
        const rect = wheelRef.current.getBoundingClientRect();
        const cx = rect.left + rect.width/2;
        const cy = rect.top + rect.height/2;
        const dx = e.clientX - cx;
        const dy = e.clientY - cy;
        const angle = Math.atan2(dy,dx)*(180/Math.PI);
        if (lastAngle !== null) {
          let diff = angle - lastAngle;
          if (diff>180) diff-=360;
          if (diff<-180) diff+=360;
          if (Math.abs(diff)>10) {
            if (diff>0) nextItem();
            else prevItem();
          }
        }
        lastAngle = angle;
      }

      if (!loggedIn) {
        return (
          <div>
            PIN:<br/>
            <input type="password" maxLength="4" value={pin} onChange={e=>setPin(e.target.value)}/>
            <br/><button onClick={handleLogin}>Entrar</button>
          </div>
        );
      }

      return (
        <div className="ipod-shell">
          <div className="battery">{battery}</div>
          <div className="ipod-screen">{renderScreen()}</div>
          <div className="clickwheel" ref={wheelRef}
            onMouseDown={startRotate} onTouchStart={startRotate}>
            <div className="btn menu" onClick={()=>{setScreen('menu'); setSelected(0);}}>MENU</div>
            <div className="btn back" onClick={prevSong}>◁◁</div>
            <div className="btn forward" onClick={nextSong}>▷▷</div>
            <div className="btn play" onClick={togglePlay}>▶❙❙</div>
            <div className="center-button" onClick={selectItem}></div>
          </div>
          <audio ref={audioRef}></audio>
        </div>
      );
    }
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
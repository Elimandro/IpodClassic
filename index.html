<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>iPod Classic Clon (React)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- React + Babel CDN -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body {
      margin: 0;
      background: #aaa;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-family: 'Courier New', monospace;
    }
    .ipod-shell {
      width: 280px;
      height: 450px;
      background: linear-gradient(to bottom, #ddd, #999);
      border-radius: 40px;
      box-shadow: inset 0 0 10px #0006, 0 10px 30px #0006;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      position: relative;
    }
    .ipod-screen {
      width: 220px;
      height: 160px;
      background: #b0c4c8;
      border: 4px solid #333;
      border-radius: 12px;
      box-shadow: inset 0 0 8px #0005;
      color: #000;
      font-size: 12px;
      padding: 8px;
      font-family: 'Courier New', monospace;
      position: relative;
    }
    .ipod-screen::before {
      content: '';
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(0deg, transparent 0 1px, #0002 1px 2px);
      border-radius: 12px;
      pointer-events: none;
    }
    .screen-item {
      padding: 2px 4px;
    }
    .selected {
      background: #000;
      color: #0f0;
    }
    #battery {
      position: absolute;
      top: 8px;
      right: 12px;
      font-size: 10px;
      color: #000;
    }
    .clickwheel {
      width: 180px;
      height: 180px;
      background: radial-gradient(circle at center, #444 0%, #111 80%);
      border-radius: 50%;
      margin-top: auto;
      position: relative;
    }
    .clickwheel .btn {
      position: absolute;
      color: white;
      font-size: 10px;
      font-weight: bold;
    }
    .btn.menu { top: 10px; left: 50%; transform: translateX(-50%); }
    .btn.back { left: 10px; top: 50%; transform: translateY(-50%); }
    .btn.forward { right: 10px; top: 50%; transform: translateY(-50%); }
    .btn.play { bottom: 10px; left: 50%; transform: translateX(-50%); }
    .center-button {
      width: 60px; height: 60px;
      border-radius: 50%; background: #333;
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      cursor: pointer;
    }
    input, button {
      margin: 4px 0;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">

    const { useState, useEffect, useRef } = React;

    function App() {
      const [pin, setPin] = useState('');
      const [loggedIn, setLoggedIn] = useState(false);
      const [battery, setBattery] = useState('--%');
      const [screen, setScreen] = useState('menu');
      const [selected, setSelected] = useState(0);
      const [songs, setSongs] = useState([]);
      const ytTitleRef = useRef(null);
      const ytUrlRef = useRef(null);

      // Load battery status
      useEffect(() => {
        if (loggedIn && 'getBattery' in navigator) {
          navigator.getBattery().then(bat => {
            setBattery(`${Math.round(bat.level*100)}%`);
            bat.addEventListener('levelchange', () => {
              setBattery(`${Math.round(bat.level*100)}%`);
            });
          });
        }
      }, [loggedIn]);

      // Load songs from storage
      useEffect(() => {
        if (pin) {
          const data = localStorage.getItem(pin);
          setSongs(data ? JSON.parse(data) : []);
        }
      }, [pin]);

      function saveSongs(newSongs) {
        localStorage.setItem(pin, JSON.stringify(newSongs));
        setSongs(newSongs);
      }

      function handleLogin() {
        if (pin.length === 4) {
          setLoggedIn(true);
          setScreen('menu');
          setSelected(0);
        } else {
          alert('PIN debe tener 4 dígitos');
        }
      }

      function renderScreen() {
        if (screen === 'menu') {
          const items = ['▶ Biblioteca','+ Añadir música'];
          return items.map((item, i) =>
            <div key={i} className={`screen-item ${i===selected?'selected':''}`}>{item}</div>);
        }
        if (screen === 'library') {
          if (songs.length === 0) return <div>No hay canciones.</div>;
          return songs.map((song,i) =>
            <div key={i} className={`screen-item ${i===selected?'selected':''}`}>{song.title}</div>);
        }
        if (screen === 'add') {
          return (
            <>
              Título:<br/>
              <input ref={ytTitleRef}/><br/>
              URL:<br/>
              <input ref={ytUrlRef}/><br/>
              <button onClick={addSong}>Guardar</button>
            </>
          );
        }
      }

      function addSong() {
        const title = ytTitleRef.current.value.trim();
        const url = ytUrlRef.current.value.trim();
        if (title && url) {
          const newList = [...songs, {title,url}];
          saveSongs(newList);
          alert('Añadido!');
          setScreen('menu');
          setSelected(0);
        } else {
          alert('Completa ambos campos');
        }
      }

      function selectItem() {
        if (screen === 'menu') {
          if (selected === 0) setScreen('library');
          else if (selected === 1) setScreen('add');
          setSelected(0);
        } else if (screen === 'library') {
          const song = songs[selected];
          if (song) window.open(song.url);
        }
      }

      function prevItem() {
        setSelected(s => Math.max(0,s-1));
      }
      function nextItem() {
        const max = screen==='menu'?1: songs.length-1;
        setSelected(s => Math.min(max,s+1));
      }

      // ClickWheel rotation
      const wheelRef = useRef(null);
      let lastAngle = null;

      function startRotate(e) {
        e.preventDefault();
        lastAngle = null;
        window.addEventListener('mousemove', rotate);
        window.addEventListener('touchmove', rotateTouch);
        window.addEventListener('mouseup', stopRotate);
        window.addEventListener('touchend', stopRotate);
      }
      function stopRotate() {
        window.removeEventListener('mousemove', rotate);
        window.removeEventListener('touchmove', rotateTouch);
      }
      function rotateTouch(e) {
        const t = e.touches[0];
        rotate({clientX:t.clientX, clientY:t.clientY});
      }
      function rotate(e) {
        const rect = wheelRef.current.getBoundingClientRect();
        const cx = rect.left + rect.width/2;
        const cy = rect.top + rect.height/2;
        const dx = e.clientX - cx;
        const dy = e.clientY - cy;
        const angle = Math.atan2(dy,dx)*(180/Math.PI);
        if (lastAngle !== null) {
          let diff = angle - lastAngle;
          if (diff>180) diff-=360;
          if (diff<-180) diff+=360;
          if (Math.abs(diff)>15) {
            if (diff>0) nextItem();
            else prevItem();
          }
        }
        lastAngle = angle;
      }

      if (!loggedIn) {
        return (
          <div id="login-screen">
            <label>PIN:</label>
            <input type="password" maxLength="4" value={pin} onChange={e=>setPin(e.target.value)}/>
            <button onClick={handleLogin}>Entrar</button>
          </div>
        )
      }

      return (
        <div className="ipod-shell">
          <div id="battery">Bat: {battery}</div>
          <div className="ipod-screen">{renderScreen()}</div>
          <div className="clickwheel" ref={wheelRef}
            onMouseDown={startRotate} onTouchStart={startRotate}>
            <div className="btn menu" onClick={()=>{setScreen('menu'); setSelected(0)}}>MENU</div>
            <div className="center-button" onClick={selectItem}></div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>